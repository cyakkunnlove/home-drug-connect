# HOME-DRUG CONNECT 要件定義書

## 1. プロジェクト概要

### 1.1 システム名
HOME-DRUG CONNECT（ホーム・ドラッグ・コネクト）

### 1.2 システムの目的
在宅医療における薬局、医療従事者、患者間の連携を効率化し、患者への薬剤配送・管理を円滑にするプラットフォームを提供する。

### 1.3 対象ユーザー
1. **薬局事業者**: 在宅医療サービスを提供する薬局
2. **医師・医療従事者**: 在宅患者の処方・ケアを行う医師、看護師
3. **システム管理者**: プラットフォーム運営者

### 1.4 期待される効果
- 薬局の在宅医療サービス可視化による患者アクセス向上
- 医療機関から薬局への患者紹介プロセスの効率化
- 薬局の患者受け入れ能力の最適化
- 在宅医療の質の向上

## 2. 機能要件

### 2.1 認証・ユーザー管理

#### 2.1.1 ユーザー登録
- **薬局管理者**: メールアドレス、パスワード、組織情報での登録
- **医師**: メールアドレス、パスワード、医師免許番号、クリニック情報での登録
- **管理者**: システム管理者による手動作成

#### 2.1.2 ログイン機能
- メールアドレス・パスワードによる認証
- パスワードリセット機能
- セッション管理（リフレッシュトークン対応）

#### 2.1.3 権限管理
- ロールベースアクセス制御（RBAC）
  - `pharmacy_admin`: 薬局管理機能へのアクセス
  - `doctor`: 医師向け機能へのアクセス
  - `admin`: システム管理機能へのアクセス

### 2.2 薬局機能

#### 2.2.1 薬局プロフィール管理
- 基本情報の登録・編集
  - 薬局名、住所、電話番号、メールアドレス
  - 営業時間（曜日別）
  - 対応可能サービス（24時間対応、休日対応、緊急対応）
  - 特殊設備（無菌調剤室、麻薬取扱い）
- 受け入れ可能患者数の設定・更新
- サービス提供範囲（km）の設定

#### 2.2.2 患者受け入れ管理
- 依頼一覧の表示・フィルタリング
- 依頼詳細の確認
- 承認・却下の回答
- 却下理由の選択（在庫不足、キャパシティ不足、対応範囲外など）

#### 2.2.3 アナリティクス
- プロフィールビュー数
- 問い合わせ数・コンバージョン率
- 月別推移グラフ

### 2.3 医師機能

#### 2.3.1 薬局検索
- 位置情報ベースの検索
- フィルタリング機能
  - 24時間対応
  - 無菌調剤室あり
  - 麻薬取扱い可能
  - 受け入れ可能状態
- 地図表示・リスト表示の切り替え

#### 2.3.2 患者紹介依頼
- 患者情報の入力
  - 服用薬（薬剤名、用量、頻度）
  - 既往歴・現疾患
  - 今後の治療方針
  - 備考
- AI支援による依頼文自動生成
- 薬剤オートコンプリート（厚労省データベース連携）

#### 2.3.3 依頼管理
- 送信済み依頼の一覧表示
- ステータス確認（回答待ち、承認、却下、期限切れ）
- 依頼詳細・薬局回答の確認

### 2.4 検索・マッチング機能

#### 2.4.1 地理的検索
- Google Maps API連携
- 住所からの緯度経度変換（ジオコーディング）
- 距離計算（PostGIS使用）
- 検索範囲指定（3km、5km、10km、20km）

#### 2.4.2 サービスマッチング
- 複数条件での絞り込み
- 空き状況のリアルタイム反映
- 検索結果の並び替え（距離順、空き状況順）

### 2.5 コミュニケーション機能

#### 2.5.1 メール通知
- 新規依頼受信通知（薬局向け）
- 依頼回答通知（医師向け）
- HTMLメールテンプレート対応

#### 2.5.2 問い合わせ機能
- 薬局への直接問い合わせ
- 問い合わせ履歴管理
- 既読・対応済みステータス管理

### 2.6 決済・サブスクリプション

#### 2.6.1 料金体系
- 月額2,200円（税込）のサブスクリプション
- 薬局のみ課金対象

#### 2.6.2 決済機能
- Stripe連携
- クレジットカード決済
- サブスクリプション管理
- 請求履歴表示
- 決済ポータルへのアクセス

### 2.7 管理者機能

#### 2.7.1 ユーザー管理
- ユーザー一覧・検索
- アカウント停止・削除
- ロール変更

#### 2.7.2 薬局承認
- 新規登録薬局の審査
- 承認・却下処理
- 却下理由の記録

#### 2.7.3 システム監視
- 利用統計の表示
- エラーログの確認
- パフォーマンスメトリクス

## 3. 非機能要件

### 3.1 性能要件
- ページ読み込み時間: 3秒以内
- API応答時間: 1秒以内
- 同時接続ユーザー数: 1,000ユーザー
- データベース容量: 10GB（初期）

### 3.2 セキュリティ要件
- HTTPS通信の強制
- パスワードハッシュ化（bcrypt）
- SQLインジェクション対策
- XSS対策
- CSRF対策
- 環境変数による秘密情報管理
- Row Level Security（RLS）によるデータアクセス制御

### 3.3 可用性要件
- サービス稼働率: 99%以上
- 計画メンテナンス: 月1回、深夜帯
- バックアップ: 日次自動バックアップ

### 3.4 ユーザビリティ要件
- レスポンシブデザイン（PC、タブレット、スマートフォン対応）
- 日本語UI
- アクセシビリティ対応（WCAG 2.1 Level AA準拠）
- 直感的な操作性

### 3.5 互換性要件
- ブラウザ対応
  - Chrome（最新版）
  - Safari（最新版）
  - Edge（最新版）
  - Firefox（最新版）
- モバイルOS
  - iOS 14以上
  - Android 8以上

### 3.6 法的要件
- 個人情報保護法準拠
- 医療情報の適切な取り扱い
- 利用規約・プライバシーポリシーの整備
- 特定商取引法に基づく表記

## 4. 制約事項

### 4.1 技術的制約
- Supabase無料プランの制限内での運用
- Vercel無料プランでのホスティング
- 外部APIの利用制限（Google Maps、OpenAI）

### 4.2 運用制約
- 24時間365日の自動運用
- 管理者による最小限の運用保守

### 4.3 予算制約
- 初期開発費用: 最小限
- 月額運用費用: 1万円以内

## 5. 前提条件

### 5.1 利用環境
- インターネット接続環境
- 最新のWebブラウザ
- JavaScriptの有効化

### 5.2 外部サービス
- Supabase（データベース、認証）
- Stripe（決済）
- Google Maps API（地図、ジオコーディング）
- OpenAI API（AI機能）
- Resend（メール送信）

### 5.3 データ連携
- 厚生労働省医薬品データベース（月次更新）

## 6. 用語定義

| 用語 | 説明 |
|------|------|
| 在宅医療 | 患者の自宅で行われる医療サービス |
| 薬局プロフィール | 薬局の基本情報、サービス内容、営業時間等を含む公開情報 |
| 患者受け入れ依頼 | 医師から薬局への在宅患者の薬剤管理依頼 |
| キャパシティ | 薬局が同時に対応可能な在宅患者数 |
| 無菌調剤室 | 無菌製剤を調製するための専用設備 |
| 麻薬取扱い | 医療用麻薬の調剤・管理が可能なこと |
